<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>NBA GM Simulator - Playoffs</title>
  <link rel="stylesheet" href="playoffs.css" />
</head>
<body>
  <div class="app">
    <header class="top-bar">
      <div class="top-bar-left">
        <div class="nba-logo">NBA</div>
        <div class="gm-tag">Playoffs Mode</div>
      </div>
      <div class="top-bar-center">
        <button class="nav-tab po-nav-tab active" data-po-tab="home">Home</button>
        <button class="nav-tab po-nav-tab" data-po-tab="bracket">Bracket</button>
        <button class="nav-tab po-nav-tab" data-po-tab="stats">Stats</button>
        <button class="nav-tab po-nav-tab" data-po-tab="news">News</button>
      </div>
      <div class="top-bar-right" id="poTopBarMeta">
        <div class="pill">ì‹œë¦¬ì¦ˆ ì •ë³´ê°€ ì¤€ë¹„ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
      </div>
    </header>

    <section id="screen-playoffs" class="screen active">
      <div class="content-shell">
        <div class="po-screen-title-row">
          <div>
            <div class="po-screen-title" id="poScreenTitle">í”Œë ˆì´ì˜¤í”„</div>
            <div class="po-screen-sub" id="poScreenSub">
              ì•„ì§ ì‹œë¦¬ì¦ˆê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="po-screen-sub">
            <span class="label">ëª¨ë“œ:</span>
            <strong>í”Œë ˆì´ì˜¤í”„ ì „ìš© í™”ë©´</strong>
          </div>
        </div>

        <div class="po-tabs-container">
          <section id="po-tab-home" class="po-tab active">
            <div class="po-home-layout">
              <div class="po-series-card" id="poSeriesCard">
                <div class="po-series-round-label" id="poSeriesRoundLabel">ì‹œë¦¬ì¦ˆ ì •ë³´ ì—†ìŒ</div>
                <div class="po-series-matchup-row" id="poSeriesMatchup"></div>
                <div class="po-series-meta" id="poSeriesMeta"></div>
                <div class="po-series-chips" id="poSeriesChips"></div>
              </div>

              <div class="po-home-actions-card">
                <div class="season-actions-title">í”Œë ˆì´ì˜¤í”„ ê´€ë¦¬</div>
                <div class="season-actions-desc">
                  ì‹œë¦¬ì¦ˆ ë°ì´í„°ê°€ ì—°ê²°ë˜ë©´ ë§ì¶¤ ì „ìˆ , ê²½ê¸° ì‹œë®¬ë ˆì´ì…˜, ìƒëŒ€ ì •ë³´ ë“±ì„
                  ì—¬ê¸°ì—ì„œ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>

                <div class="po-home-actions-row">
                  <button id="poBtnTactics" class="btn" disabled>ğŸ¯ ìƒëŒ€ ë§ì¶¤ ì „ìˆ </button>
                  <button id="poBtnPlayGame" class="btn btn-primary" disabled>â–¶ ê²Œì„ ì§„í–‰</button>
                  <button id="poBtnOppInfo" class="btn" disabled>ğŸ” ìƒëŒ€ ì •ë³´</button>
                </div>
                <p class="po-note">
                  í•„ìš”í•œ ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ ë²„íŠ¼ì´ ìë™ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤.
                </p>
              </div>
            </div>
          </section>

          <section id="po-tab-bracket" class="po-tab">
            <div class="po-bracket-grid" id="poBracketGrid">
              <div class="empty-state">ë¸Œë¼ì¼“ ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
          </section>

          <section id="po-tab-stats" class="po-tab">
            <div class="stats-card">
              <h3>Playoffs Stats Leaders</h3>
              <p class="muted">í”Œë ˆì´ì˜¤í”„ ê²½ê¸° ê¸°ë¡ì´ ìˆ˜ì§‘ë˜ë©´ ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</p>

              <div class="stats-controls" id="poStatsFilters"></div>

              <table class="stats-table" aria-label="Playoff stats table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>ì„ ìˆ˜</th>
                    <th>íŒ€</th>
                    <th>G</th>
                    <th>MIN</th>
                    <th>PTS</th>
                    <th>REB</th>
                    <th>AST</th>
                    <th>FG%</th>
                  </tr>
                </thead>
                <tbody id="poStatsTableBody">
                  <tr class="empty-state-row">
                    <td colspan="9">í”Œë ˆì´ì˜¤í”„ ìŠ¤íƒ¯ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="po-tab-news" class="po-tab">
            <div class="news-card">
              <h3>Playoffs News Center</h3>
              <p class="muted">
                ê²½ê¸° ê²°ê³¼, ë¸Œë¼ì¼“ ë³€ë™, íŒ€ ë¦¬í¬íŠ¸ê°€ ì—°ê²°ë˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
              </p>
              <div id="poNewsFeed">
                <div class="empty-state">ë‰´ìŠ¤ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </div>

  <script>
    const poNavTabs = document.querySelectorAll(".po-nav-tab");
    const poTabs = {
      home: document.getElementById("po-tab-home"),
      bracket: document.getElementById("po-tab-bracket"),
      stats: document.getElementById("po-tab-stats"),
      news: document.getElementById("po-tab-news"),
    };

    poNavTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.poTab;
        poNavTabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        Object.values(poTabs).forEach((el) => el.classList.remove("active"));
        if (poTabs[tab]) {
          poTabs[tab].classList.add("active");
        }
      });
    });

    function renderTopBar(meta = []) {
      const container = document.getElementById("poTopBarMeta");
      container.innerHTML = "";
      if (!meta.length) {
        container.innerHTML = '<div class="pill">ì‹œë¦¬ì¦ˆ ì •ë³´ê°€ ì¤€ë¹„ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>';
        return;
      }
      meta.forEach((item) => {
        const pill = document.createElement("div");
        pill.className = "pill" + (item.strong ? " pill-strong" : "");
        pill.innerHTML = `${item.label}: <strong>&nbsp;${item.value}</strong>`;
        container.appendChild(pill);
      });
    }

    function renderSeriesCard(series, roundName = "") {
      const roundLabelEl = document.getElementById("poSeriesRoundLabel");
      const matchupRow = document.getElementById("poSeriesMatchup");
      const meta = document.getElementById("poSeriesMeta");
      const chips = document.getElementById("poSeriesChips");
      const title = document.getElementById("poScreenTitle");
      const sub = document.getElementById("poScreenSub");

      if (!series) {
        roundLabelEl.textContent = "ì‹œë¦¬ì¦ˆ ì •ë³´ ì—†ìŒ";
        matchupRow.innerHTML = '<div class="empty-state">ì‹œë¦¬ì¦ˆ ë§¤ì¹˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        meta.textContent = "";
        chips.innerHTML = "";
        title.textContent = "í”Œë ˆì´ì˜¤í”„";
        sub.textContent = "ì•„ì§ ì‹œë¦¬ì¦ˆê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }

      const homeId = series.home_court;
      const roadId = series.road;
      const wins = series.wins || {};
      const bestOf = series.best_of || 7;
      const gamesPlayed = (series.games || []).length;
      const homeSeed = series.home_entry?.seed ?? "-";
      const roadSeed = series.road_entry?.seed ?? "-";
      const homeLabel = series.home_entry?.team_id || homeId || "Home Team";
      const roadLabel = series.road_entry?.team_id || roadId || "Away Team";

      roundLabelEl.textContent = roundName || series.round || "ì‹œë¦¬ì¦ˆ";
      title.textContent = `í”Œë ˆì´ì˜¤í”„ Â· ${roundName || series.round || "ì‹œë¦¬ì¦ˆ"}`;
      sub.textContent = `${homeLabel} vs ${roadLabel}`;

      matchupRow.innerHTML = "";
      const userBlock = document.createElement("div");
      userBlock.className = "po-team-block po-team-user";
      userBlock.innerHTML = `
        <div class="po-team-name">
          ${homeLabel}
          <span>(${homeSeed})</span>
        </div>
        <div class="po-team-record">${wins[homeId] ?? 0}ìŠ¹</div>
      `;

      const oppBlock = document.createElement("div");
      oppBlock.className = "po-team-block po-team-opponent";
      oppBlock.innerHTML = `
        <div class="po-team-name">
          ${roadLabel}
          <span>(${roadSeed})</span>
        </div>
        <div class="po-team-record">${wins[roadId] ?? 0}ìŠ¹</div>
      `;

      const vs = document.createElement("div");
      vs.className = "po-vs";
      vs.textContent = "vs";

      matchupRow.appendChild(userBlock);
      matchupRow.appendChild(vs);
      matchupRow.appendChild(oppBlock);

      meta.innerHTML = "";
      const metaItems = [
        series.matchup ? `ë§¤ì¹˜ì—…: ${series.matchup}` : null,
        bestOf ? `ì‹œë¦¬ì¦ˆ: ${bestOf}ì „ ${Math.floor(bestOf / 2) + 1}ì„ ìŠ¹` : null,
        gamesPlayed || gamesPlayed === 0 ? `ì§„í–‰ ê²½ê¸°: ${gamesPlayed}` : null,
      ].filter(Boolean);

      metaItems.forEach((text, index) => {
        const span = document.createElement("span");
        span.textContent = text;
        meta.appendChild(span);
        if (index < metaItems.length - 1) {
          const dot = document.createElement("span");
          dot.className = "dot";
          meta.appendChild(dot);
        }
      });

      chips.innerHTML = "";
      const winnerTeam = series.winner?.team_id || series.winner;
      const statusChip = document.createElement("span");
      statusChip.className = "po-series-chip";
      statusChip.textContent = winnerTeam
        ? `ì‹œë¦¬ì¦ˆ ì¢…ë£Œ Â· ìš°ìŠ¹: ${winnerTeam}`
        : "ì‹œë¦¬ì¦ˆ ì§„í–‰ ì¤‘";
      chips.appendChild(statusChip);

      const buttons = [
        document.getElementById("poBtnTactics"),
        document.getElementById("poBtnPlayGame"),
        document.getElementById("poBtnOppInfo"),
      ];
      buttons.forEach((btn) => (btn.disabled = false));
    }

    function renderBracket(playoffs = null) {
      const grid = document.getElementById("poBracketGrid");
      grid.innerHTML = "";
      if (!playoffs || !playoffs.bracket) {
        grid.innerHTML = '<div class="empty-state">ë¸Œë¼ì¼“ ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const bracket = playoffs.bracket;
      const conferences = [
        { key: "east", title: "Eastern Conference" },
        { key: "west", title: "Western Conference" },
      ];

      conferences.forEach((conf) => {
        const column = document.createElement("div");
        column.className = "po-bracket-column";
        column.innerHTML = `
          <div class="po-bracket-title-row">
            <h3>${conf.title}</h3>
            <span class="label">ì‹œë¦¬ì¦ˆ ì§„í–‰ ìƒí™©</span>
          </div>
        `;
        const rounds = document.createElement("div");
        rounds.className = "po-bracket-rounds";

        const confBracket = bracket[conf.key] || {};
        const roundDefs = [
          { title: "1R", list: confBracket.quarterfinals || [] },
          { title: "Semis", list: confBracket.semifinals || [] },
          { title: "Finals", list: confBracket.finals ? [confBracket.finals] : [] },
        ];

        roundDefs.forEach((round) => {
          const roundEl = document.createElement("div");
          roundEl.className = "po-bracket-round";
          roundEl.innerHTML = `<div class="po-round-title">${round.title}</div>`;

          if (!round.list?.length) {
            const placeholder = document.createElement("div");
            placeholder.className = "muted";
            placeholder.textContent = "ë§¤ì¹˜ì—…ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.";
            roundEl.appendChild(placeholder);
          }

          (round.list || []).forEach((series) => {
            const seriesEl = document.createElement("div");
            seriesEl.className = "po-series-mini";
            const wins = series.wins || {};
            const homeId = series.home_court;
            const roadId = series.road;
            const lines = [
              {
                seed: series.home_entry?.seed ?? "-",
                team: series.home_entry?.team_id || homeId || "-",
                record: wins[homeId] ?? 0,
              },
              {
                seed: series.road_entry?.seed ?? "-",
                team: series.road_entry?.team_id || roadId || "-",
                record: wins[roadId] ?? 0,
              },
            ];

            lines.forEach((line) => {
              const lineEl = document.createElement("div");
              lineEl.className = "po-series-line";
              lineEl.innerHTML = `
                <span class="seed">${line.seed ?? "-"}</span>
                <span class="team-code">${line.team || "-"}</span>
                <span class="record">${line.record ?? "-"}</span>
              `;
              seriesEl.appendChild(lineEl);
            });
            const status = document.createElement("div");
            status.className = "series-status";
            status.textContent = series.winner?.team_id
              ? `ì¢…ë£Œ Â· ${series.winner.team_id}`
              : "ì§„í–‰ ì¤‘";
            seriesEl.appendChild(status);
            roundEl.appendChild(seriesEl);
          });

          rounds.appendChild(roundEl);
        });

        column.appendChild(rounds);
        grid.appendChild(column);
      });

      if (bracket.finals) {
        const finalsCol = document.createElement("div");
        finalsCol.className = "po-bracket-column";
        finalsCol.innerHTML = `
          <div class="po-bracket-title-row">
            <h3>NBA Finals</h3>
            <span class="label">ìµœì¢… ë¼ìš´ë“œ</span>
          </div>
        `;
        const rounds = document.createElement("div");
        rounds.className = "po-bracket-rounds";

        const roundEl = document.createElement("div");
        roundEl.className = "po-bracket-round";
        roundEl.innerHTML = `<div class="po-round-title">Finals</div>`;

        const series = bracket.finals;
        if (series) {
          const seriesEl = document.createElement("div");
          seriesEl.className = "po-series-mini";
          const wins = series.wins || {};
          const homeId = series.home_court;
          const roadId = series.road;
          const lines = [
            {
              seed: series.home_entry?.seed ?? "-",
              team: series.home_entry?.team_id || homeId || "-",
              record: wins[homeId] ?? 0,
            },
            {
              seed: series.road_entry?.seed ?? "-",
              team: series.road_entry?.team_id || roadId || "-",
              record: wins[roadId] ?? 0,
            },
          ];

          lines.forEach((line) => {
            const lineEl = document.createElement("div");
            lineEl.className = "po-series-line";
            lineEl.innerHTML = `
              <span class="seed">${line.seed ?? "-"}</span>
              <span class="team-code">${line.team || "-"}</span>
              <span class="record">${line.record ?? "-"}</span>
            `;
            seriesEl.appendChild(lineEl);
          });
          const status = document.createElement("div");
          status.className = "series-status";
          status.textContent = series.winner?.team_id
            ? `ì¢…ë£Œ Â· ${series.winner.team_id}`
            : "ì§„í–‰ ì¤‘";
          seriesEl.appendChild(status);
          roundEl.appendChild(seriesEl);
        }

        rounds.appendChild(roundEl);
        finalsCol.appendChild(rounds);
        grid.appendChild(finalsCol);
      }
    }

    function renderStats(categories = [], stats = []) {
      const filters = document.getElementById("poStatsFilters");
      const tbody = document.getElementById("poStatsTableBody");
      filters.innerHTML = "";

      categories.forEach((cat, idx) => {
        const btn = document.createElement("button");
        btn.className = "btn btn-ghost" + (idx === 0 ? " active" : "");
        btn.textContent = cat;
        filters.appendChild(btn);
      });

      tbody.innerHTML = "";
      if (!stats.length) {
        tbody.innerHTML = '<tr class="empty-state-row"><td colspan="9">í”Œë ˆì´ì˜¤í”„ ìŠ¤íƒ¯ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      stats.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.rank}</td>
          <td class="stats-player-name">${row.player} <span class="stats-team-tag">${row.team} Â· ${row.detail}</span></td>
          <td>${row.team}</td>
          <td>${row.games}</td>
          <td>${row.minutes}</td>
          <td class="stat-highlight">${row.points}</td>
          <td>${row.rebounds}</td>
          <td>${row.assists}</td>
          <td>${row.fg}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function fetchJson(url, options = {}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`Request failed: ${res.status}`);
        return await res.json();
      } catch (err) {
        console.error("í”Œë ˆì´ì˜¤í”„ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨", err);
        return null;
      }
    }

    function findSeriesForTeam(playoffs, teamId) {
      if (!playoffs || !teamId) return null;
      const bracket = playoffs.bracket || {};
      const roundName = playoffs.current_round || "Conference Quarterfinals";
      const roundSeries = (function () {
        if (roundName === "Conference Quarterfinals") {
          return (bracket.east?.quarterfinals || []).concat(
            bracket.west?.quarterfinals || []
          );
        }
        if (roundName === "Conference Semifinals") {
          return (bracket.east?.semifinals || []).concat(bracket.west?.semifinals || []);
        }
        if (roundName === "Conference Finals") {
          return (bracket.east?.finals ? [bracket.east.finals] : []).concat(
            bracket.west?.finals ? [bracket.west.finals] : []
          );
        }
        if (roundName === "NBA Finals") {
          return bracket.finals ? [bracket.finals] : [];
        }
        return [];
      })();

      return roundSeries.find(
        (series) => series && [series.home_court, series.road].includes(teamId)
      );
    }

    function buildTopBarMeta(playoffs, series, myTeamId) {
      if (!playoffs || !series) return [];
      const wins = series.wins || {};
      const homeId = series.home_court;
      const roadId = series.road;
      const scoreLabel = `${wins[homeId] ?? 0}-${wins[roadId] ?? 0}`;
      const pills = [
        { label: "í˜„ì¬ ë¼ìš´ë“œ", value: playoffs.current_round || "-" },
        { label: "ì‹œë¦¬ì¦ˆ", value: series.matchup || `${homeId || "-"} vs ${roadId || "-"}` },
        { label: "í˜„ì¬ ìŠ¤ì½”ì–´", value: scoreLabel },
      ];

      if (myTeamId) {
        pills.push({ label: "ë‚´ íŒ€", value: myTeamId, strong: true });
      }

      if (series.winner?.team_id) {
        pills.push({ label: "ìŠ¹ì", value: series.winner.team_id, strong: true });
      }

      return pills;
    }

    function renderNews(news = []) {
      const feed = document.getElementById("poNewsFeed");
      feed.innerHTML = "";
      if (!news.length) {
        feed.innerHTML = '<div class="empty-state">ë‰´ìŠ¤ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      news.forEach((item, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "news-item";
        wrapper.innerHTML = `
          <div class="news-headline">${item.headline}</div>
          <div class="news-meta">${item.meta}</div>
          <div class="news-body">${item.body}</div>
        `;
        feed.appendChild(wrapper);
        if (index < news.length - 1) {
          const divider = document.createElement("div");
          divider.className = "news-divider";
          feed.appendChild(divider);
        }
      });
    }

    async function loadPlayoffsScreen() {
      const postseason = await fetchJson("/api/postseason/state");
      const playoffs = postseason?.playoffs || null;
      const myTeamId = postseason?.my_team_id || null;
      const mySeries = findSeriesForTeam(playoffs, myTeamId) || null;

      renderTopBar(buildTopBarMeta(playoffs, mySeries, myTeamId));
      renderSeriesCard(mySeries, playoffs?.current_round || "");
      renderBracket(playoffs);

      // Stats/News endpoints are not wired yet; keep empty states until backend supplies them.
      renderStats([], []);
      renderNews([]);
    }

    loadPlayoffsScreen();
  </script>
</body>
</html>
